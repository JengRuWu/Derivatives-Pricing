Sub Button1_Click()Dim Time0Time0 = TimerDim St, K, rr, q, sigma, Tt, M, n, Savet, t, sim, rep, u, dSt = Cells(1, 2)K = Cells(2, 2)rr = Cells(3, 2)q = Cells(4, 2)sigma = Cells(5, 2)Tt = Cells(6, 2)M = Cells(7, 2)n = Cells(8, 2)Savet = Cells(9, 2)t = Cells(10, 2)sim = Cells(11, 2)rep = Cells(12, 2)u = Exp(sigma * Sqr(Tt / n))d = 1 / up = (Exp((rr - q) * Tt / n) - d) / (u - d)Dim Amax(), Amin(), A(), payoff(), payoffa()ReDim Amax(n, n), Amin(n, n), A(n, n, M), payoff(n, n, M), payoffa(n, n, M)n_t = n * t / TtFor j = 0 To n    Amax(n, j) = St * (1 - u ^ (n - j + 1)) / (1 - u) + St * u ^ (n - j) * d * (1 - d ^ j) / (1 - d) - St + Savet * (n_t + 1)    Amax(n, j) = Amax(n, j) / (n + 1 + n_t)    Amin(n, j) = St * (1 - d ^ (j + 1)) / (1 - d) + St * d ^ j * u * (1 - u ^ (n - j)) / (1 - u) - St + Savet * (n_t + 1)    Amin(n, j) = Amin(n, j) / (n + 1 + n_t)        For w = 0 To M        A(n, j, w) = (M - w) / M * Amax(n, j) + w / M * Amin(n, j)        payoff(n, j, w) = WorksheetFunction.Max(A(n, j, w) - K, 0)        payoffa(n, j, w) = WorksheetFunction.Max(A(n, j, w) - K, 0)    Next wNext j'_____Amax_Amin∏ÚAminFor i = n - 1 To 0 Step -1    For j = 0 To i        Amax(i, j) = St * (1 - u ^ (i - j + 1)) / (1 - u) + St * u ^ (i - j) * d * (1 - d ^ j) / (1 - d) - St + Savet * (n_t + 1)        Amax(i, j) = Amax(i, j) / (i + 1 + n_t)        Amin(i, j) = St * (1 - d ^ (j + 1)) / (1 - d) + St * d ^ j * u * (1 - u ^ (i - j)) / (1 - u) - St + Savet * (n_t + 1)        Amin(i, j) = Amin(i, j) / (i + 1 + n_t)                For w = 0 To M            '______≠±¥X¥¡            If j = 0 Or j = i Then                A(i, j, w) = Amin(i, j)            Else                A(i, j, w) = (M - w) / M * Amax(i, j) + w / M * Amin(i, j)            End If            '_Au_AdAd            Au = ((i + n_t + 1) * A(i, j, w) + St * u ^ (i - j + 1) * d ^ j) / (i + 2 + n_t)            Ad = ((i + n_t + 1) * A(i, j, w) + St * u ^ (i - j) * d ^ (j + 1)) / (i + 2 + n_t)            '___U¥¡            If Abs(Au - A(i + 1, j, 0)) < 10 ^ (-10) Then                Cu = payoff(i + 1, j, 0)                Cua = payoffa(i + 1, j, 0)            ElseIf Abs(Au - A(i + 1, j, M)) < 10 ^ (-10) Then                Cu = payoff(i + 1, j, M)                Cua = payoffa(i + 1, j, M)            Else                x = 0                Do While A(i + 1, j, x) > Au                    x = x + 1                Loop                    Zu = (A(i + 1, j, x - 1) - Au) / (A(i + 1, j, x - 1) - A(i + 1, j, x))                    Cu = Zu * payoff(i + 1, j, x) + (1 - Zu) * payoff(i + 1, j, x - 1)                    Cua = Zu * payoffa(i + 1, j, x) + (1 - Zu) * payoffa(i + 1, j, x - 1)            End If            If Abs(Ad - A(i + 1, j + 1, 0)) < 10 ^ (-10) Then                Cd = payoff(i + 1, j + 1, 0)                Cda = payoffa(i + 1, j + 1, 0)            ElseIf Abs(Ad - A(i + 1, j + 1, M)) < 10 ^ (-10) Then                Cd = payoff(i + 1, j + 1, M)                Cda = payoffa(i + 1, j + 1, M)            Else                y = 0                Do While A(i + 1, j + 1, y) > Ad                    y = y + 1                Loop                    Zd = (A(i + 1, j + 1, y - 1) - Ad) / (A(i + 1, j + 1, y - 1) - A(i + 1, j + 1, y))                    Cd = Zd * payoff(i + 1, j + 1, y) + (1 - Zd) * payoff(i + 1, j + 1, y - 1)                    Cda = Zd * payoffa(i + 1, j + 1, y) + (1 - Zd) * payoffa(i + 1, j + 1, y - 1)            End If            payoff(i, j, w) = (p * Cu + (1 - p) * Cd) * Exp(-rr * Tt / n)            payoffa(i, j, w) = (p * Cua + (1 - p) * Cda) * Exp(-rr * Tt / n)            payoffa(i, j, w) = WorksheetFunction.Max(A(i, j, w) - K, payoffa(i, j, w))        Next w    Next jNext i    Cells(3, 7) = "European Call"Cells(3, 8) = payoff(0, 0, 0)Cells(4, 7) = "American Call"Cells(4, 8) = payoffa(0, 0, 0)        MsgBox ("Time: " & Timer - Time0 & " _Ì")End Sub
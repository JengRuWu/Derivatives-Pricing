Sub Button3_Click()Dim n, K, r, T, rep, simn = Cells(1, 8)K = Cells(2, 8)r = Cells(3, 8)T = Cells(4, 8)rep = Cells(5, 8)sim = Cells(6, 8)Dim S0(), q(), sigma(), miu()ReDim S0(1 To n), q(1 To n), sigma(1 To n), miu(1 To n)For i = 1 To n    S0(i) = Cells(i, 2)    q(i) = Cells(i, 4)    sigma(i) = Cells(i, 6)    miu(i) = Log(S0(i)) + (r - q(i) - sigma(i) * sigma(i) / 2) * TNext i'__rhohoDim rho()ReDim rho(1 To n, 1 To n)For i = 1 To n    For j = 1 To n        rho(i, j) = Cells(i + 12, j + 1)    Next jNext i'CholeskyDim A()ReDim A(1 To n, 1 To n)'Step 1A(1, 1) = Sqr(sigma(1) ^ 2 * T)For i = 2 To n    A(1, i) = sigma(1) * sigma(i) * T * rho(1, i) / A(1, 1)    A(i, 1) = 0Next iFor i = 2 To n - 1'Step 2    A(i, i) = sigma(i) * sigma(i) * T    For w = 1 To i - 1        A(i, i) = A(i, i) - A(w, i) * A(w, i)    Next w    A(i, i) = Sqr(A(i, i))'Step 3    For j = i + 1 To n        A(i, j) = sigma(i) * sigma(j) * rho(i, j) * T        For w = 1 To i - 1            A(i, j) = A(i, j) - A(w, i) * A(w, j)        Next w        A(i, j) = A(i, j) / A(i, i)        A(j, i) = 0    Next jNext i'Step 4A(n, n) = sigma(n) * sigma(n) * TFor w = 1 To n - 1    A(n, n) = A(n, n) - A(w, n) * A(w, n)Next wA(n, n) = Sqr(Abs(A(n, n)))Dim repetition()ReDim repetition(1 To rep)For g = 1 To rep    'Monte Carlo    Dim Z()    ReDim Z(1 To sim, 1 To n)    For i = 1 To n        For j = 1 To sim / 2            Z(j, i) = WorksheetFunction.NormSInv(Rnd())            Z(j + sim / 2, i) = -Z(j, i)        Next j    Next i        Dim cov_matrix()    ReDim cov_matrix(1 To n, 1 To n)        'covarinace mariex    For i = 1 To n        For j = i To n            Dim temp_covariance            temp_covariance = 0            For w = 1 To sim / 2                temp_covariance = temp_covariance + Z(w, i) * Z(w, j) * 2            Next w            temp_covariance = temp_covariance / (sim - 1)            cov_matrix(i, j) = temp_covariance        Next j    Next i    '__A*A*    Dim Astar()    ReDim Astar(1 To n, 1 To n)        'Step 1    Astar(1, 1) = Sqr(cov_matrix(1, 1))    For i = 2 To n        Astar(1, i) = cov_matrix(1, i) / Astar(1, 1)        Astar(i, 1) = 0    Next i        For i = 2 To n - 1    'Step 2        Astar(i, i) = cov_matrix(i, i)        For w = 1 To i - 1            Astar(i, i) = Astar(i, i) - Astar(w, i) * Astar(w, i)        Next w        Astar(i, i) = Sqr(Astar(i, i))    'Step 3        For j = i + 1 To n            Astar(i, j) = cov_matrix(i, j)            For w = 1 To i - 1                Astar(i, j) = Astar(i, j) - Astar(w, i) * Astar(w, j)            Next w            Astar(i, j) = Astar(i, j) / Astar(i, i)            Astar(j, i) = 0        Next j    Next i    'Step 4    Astar(n, n) = cov_matrix(n, n)    For w = 1 To n - 1        Astar(n, n) = Astar(n, n) - Astar(w, n) * Astar(w, n)    Next w    Astar(n, n) = Sqr(Astar(n, n))    Astar_inv = WorksheetFunction.MInverse(Astar)            Atemp = WorksheetFunction.MMult(Astar_inv, A)    rsim = WorksheetFunction.MMult(Z, Atemp)        Dim payoff()    ReDim payoff(1 To sim)        For i = 1 To sim        Dim temp()        ReDim temp(1 To n)        For j = 1 To n            rsim(i, j) = rsim(i, j) + miu(j)            rsim(i, j) = Exp(rsim(i, j))            temp(j) = rsim(i, j)        Next j        payoff(i) = WorksheetFunction.Max(WorksheetFunction.Max(temp()) - K, 0)    Next i    repetition(g) = WorksheetFunction.Average(payoff()) * Exp(-r * T)Next gDim mean, sdmean = WorksheetFunction.Average(repetition())sd = WorksheetFunction.StDev(repetition())Cells(37, 5) = "Mean"Cells(38, 5) = "SD"Cells(39, 5) = "Lower Bound"Cells(40, 5) = "Upper Bound"Cells(37, 6) = meanCells(38, 6) = sdCells(39, 6) = mean - 2 * sdCells(40, 6) = mean + 2 * sdEnd Sub